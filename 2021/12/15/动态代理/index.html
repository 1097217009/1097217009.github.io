

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="安">
  <meta name="keywords" content="">
  <meta name="description" content="1.代理模式代理模式是指，为其他对象提供一种代理可以控制这个对象的访问。在某些情况下，一个对象不适合或者不能直接引用另一个对象，而代理对象可以在客户类和目标对象之间起到中介的作用。另外一个意思是，使用代理对象，是为了在不修改目标对象的基础上，&#x3D;&#x3D;增强主业务逻辑&#x3D;&#x3D;。客户类真正想访问的对象是目标对象，但客户类真正可以访问的对象是代理对象。客户类对目标对象的访问是通过访问代理对象来实现的。当然，代理类">
<meta property="og:type" content="article">
<meta property="og:title" content="动态代理">
<meta property="og:url" content="http://example.com/2021/12/15/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/index.html">
<meta property="og:site_name" content="安的博客">
<meta property="og:description" content="1.代理模式代理模式是指，为其他对象提供一种代理可以控制这个对象的访问。在某些情况下，一个对象不适合或者不能直接引用另一个对象，而代理对象可以在客户类和目标对象之间起到中介的作用。另外一个意思是，使用代理对象，是为了在不修改目标对象的基础上，&#x3D;&#x3D;增强主业务逻辑&#x3D;&#x3D;。客户类真正想访问的对象是目标对象，但客户类真正可以访问的对象是代理对象。客户类对目标对象的访问是通过访问代理对象来实现的。当然，代理类">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-12-15T05:02:11.000Z">
<meta property="article:modified_time" content="2021-12-15T05:14:26.680Z">
<meta property="article:author" content="安">
<meta name="twitter:card" content="summary_large_image">
  
  <title>动态代理 - 安的博客</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>An&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="动态代理">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-12-15 13:02" pubdate>
        2021年12月15日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      22k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      70 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">动态代理</h1>
            
            <div class="markdown-body">
              <h1 id="1-代理模式"><a href="#1-代理模式" class="headerlink" title="1.代理模式"></a>1.代理模式</h1><p>代理模式是指，为其他对象提供一种代理可以控制这个对象的访问。在某些情况下，一个对象不适合或者不能直接引用另一个对象，而代理对象可以在客户类和目标对象之间起到中介的作用。另外一个意思是，使用代理对象，是为了在不修改目标对象的基础上，==增强主业务逻辑==。客户类真正想访问的对象是目标对象，但客户类真正可以访问的对象是代理对象。客户类对目标对象的访问是通过访问代理对象来实现的。当然，代理类与目标类要实现同一个接口（JDK动态代理）。</p>
<p>例如：结婚需要找中介帮忙布置场所什么的。</p>
<p>使用代理模式的作用：</p>
<p>==1.功能增强==</p>
<p>2.控制访问</p>
<h1 id="2-实现代理的方式"><a href="#2-实现代理的方式" class="headerlink" title="2.实现代理的方式"></a>2.实现代理的方式</h1><h2 id="1-静态代理："><a href="#1-静态代理：" class="headerlink" title="1.静态代理："></a>1.静态代理：</h2><p>代理类是自己手工实现的，自己创建一个java类，表示代理类，同时你所要代理的目标类是确定的</p>
<p>特点：1）实现简单 2）容易理解</p>
<p>例子：模拟一个用户购买u盘的行为</p>
<p>​    用户是客户类</p>
<p>​    商家是代理对象，代理某个品牌的值</p>
<p>​    厂家是目标类</p>
<p>实现步骤：</p>
<p>​    1.创建一个接口，定义卖u盘的方法，表示厂家和商家做的事情</p>
<p>​    2.创建厂家类，实现步骤1的接口</p>
<p>​    3.创建商家，也就是代理，也需要实现步骤1的接口</p>
<p>​    3.创建客户类，调用商家的方法买一个u盘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UsbSale</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sale</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//厂家</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UsbFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UsbSale</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sale</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;生产了U盘&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//商家(代理)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UsbProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UsbSale</span></span>&#123;<br>    <span class="hljs-keyword">private</span> UsbFactory usbFactory;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sale</span><span class="hljs-params">()</span></span>&#123;<br>        usbFactory.sale();<br>        System.out.println(<span class="hljs-string">&quot;卖出了商家生产的U盘&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//客户</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>	<span class="hljs-params">(String[] args)</span></span>&#123;<br>        UsbProxy usbProxy;<br>        usbProxy.sale();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>静态代理的缺点：</p>
<p>1.当目标类增多了，代理也会相应的增多。</p>
<p>2.当接口中方法新增或减少时，代理对象也要相应改变。</p>
<h2 id="2-动态代理："><a href="#2-动态代理：" class="headerlink" title="2.动态代理："></a>2.动态代理：</h2><p>在静态代理中目标类很多时候，可以使用动态代理，避免静态代理的缺点</p>
<p>动态代理中目标类即使很多，1）代理类数量可以很少    2）当你修改了接口中的方法时，不会影响代理类</p>
<h3 id="1-JDK动态代理："><a href="#1-JDK动态代理：" class="headerlink" title="1.JDK动态代理："></a>1.JDK动态代理：</h3><p>在程序的执行过程中，使用jdk的反射机制，创建代理类对象，并且动态的指定要代理的目标类。换句话说：动态代理是一种创建java对象的能力，让我们可以在运行过程中动态创建代理对象。</p>
<p>一般情况下，在java中想要创建对象：</p>
<p>1.创建类文件，java文件编译为class</p>
<p>2.使用构造方法，创建类对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//目标对象实现的接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Target</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//目标对象1</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyTarget1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Target</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;do&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//目标对象2</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyTarget2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Target</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;do other things&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//JDK动态代理,这个类MyProxyInvocationHandler实现InvocationHandler接口，通过其中getProxy()得到的代理对象会有构造方法带有参数MyProxyInvocationHandler，代理对象在调用目标接口的方法时会通过调用MyProxyInvocationHandler对象中的invoke(Object o, Method method, Object[] objects)方式。</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyProxyInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span></span>&#123;<br>    <span class="hljs-comment">//要代理的目标类，类型为Object类，也就是说可以为任何类型的类创建代理，但是这个类一定要实现某个接口，因为JDK代理的是接口</span><br>    <span class="hljs-keyword">private</span> Object object;<br>    <span class="hljs-comment">//set方法实现注入</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setObject</span><span class="hljs-params">(Object object)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.object = object;<br>    &#125;<br>    <br>    <span class="hljs-comment">//动态创建代理类</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getProxy</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(object.getClass().getClassLoader(),object.getClass().getInterface,<span class="hljs-keyword">this</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">//实现增强的地方</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object o, Method method, Object[] objects)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        Object obj = method.invoke(object,objects);<br>        System.out.println(<span class="hljs-string">&quot;实现增强&quot;</span>);<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>jdk动态代理原理分析</p>
<p>主要分析的地方是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Proxy.newProxyInstance(object.getClass().getClassLoader(),object.getClass().getInterface,<span class="hljs-keyword">this</span>);<br></code></pre></td></tr></table></figure>

<p>进去源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">newProxyInstance</span><span class="hljs-params">(ClassLoader loader,</span></span><br><span class="hljs-params"><span class="hljs-function">                                          Class&lt;?&gt;[] interfaces,</span></span><br><span class="hljs-params"><span class="hljs-function">                                          InvocationHandler h)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> IllegalArgumentException</span><br><span class="hljs-function">    </span>&#123;<br>        Objects.requireNonNull(h);<br><br>        <span class="hljs-keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();<br>        <span class="hljs-keyword">final</span> SecurityManager sm = System.getSecurityManager();<br>        <span class="hljs-keyword">if</span> (sm != <span class="hljs-keyword">null</span>) &#123;<br>            checkProxyAccess(Reflection.getCallerClass(), loader, intfs);<br>        &#125;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * Look up or generate the designated proxy class.</span><br><span class="hljs-comment">         */</span><br>        Class&lt;?&gt; cl = getProxyClass0(loader, intfs); <span class="hljs-comment">//再进入getProxyClass0()方法的源码</span><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * Invoke its constructor with the designated invocation handler.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (sm != <span class="hljs-keyword">null</span>) &#123;<br>                checkNewProxyPermission(Reflection.getCallerClass(), cl);<br>            &#125;<br><br>            <span class="hljs-keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);<br>            <span class="hljs-keyword">final</span> InvocationHandler ih = h;<br>            <span class="hljs-keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) &#123;<br>                AccessController.doPrivileged(<span class="hljs-keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;<br>                    <span class="hljs-function"><span class="hljs-keyword">public</span> Void <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                        cons.setAccessible(<span class="hljs-keyword">true</span>);<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                    &#125;<br>                &#125;);<br>            &#125;<br>            <span class="hljs-keyword">return</span> cons.newInstance(<span class="hljs-keyword">new</span> Object[]&#123;h&#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException|InstantiationException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InternalError(e.toString(), e);<br>        &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>            Throwable t = e.getCause();<br>            <span class="hljs-keyword">if</span> (t <span class="hljs-keyword">instanceof</span> RuntimeException) &#123;<br>                <span class="hljs-keyword">throw</span> (RuntimeException) t;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InternalError(t.toString(), t);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InternalError(e.toString(), e);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p> Class&lt;?&gt; cl = getProxyClass0(loader, intfs);的源码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; getProxyClass0(ClassLoader loader,<br>                                       Class&lt;?&gt;... interfaces) &#123;<br>    <span class="hljs-keyword">if</span> (interfaces.length &gt; <span class="hljs-number">65535</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;interface limit exceeded&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// If the proxy class defined by the given loader implementing</span><br>    <span class="hljs-comment">// the given interfaces exists, this will simply return the cached copy;</span><br>    <span class="hljs-comment">// otherwise, it will create the proxy class via the ProxyClassFactory</span><br>    <span class="hljs-keyword">return</span> proxyClassCache.get(loader, interfaces);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>proxyClassCache.get(loader, interfaces)</p>
<p>proxyClassCache是WeakCache对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> WeakCache&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;<br>    proxyClassCache = <span class="hljs-keyword">new</span> WeakCache&lt;&gt;(<span class="hljs-keyword">new</span> KeyFactory(), <span class="hljs-keyword">new</span> ProxyClassFactory());<br></code></pre></td></tr></table></figure>

<p>进入到WeakCache类的get()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">get</span><span class="hljs-params">(K key, P parameter)</span> </span>&#123;<br>        Objects.requireNonNull(parameter);<br><br>        expungeStaleEntries();<br><br>        Object cacheKey = CacheKey.valueOf(key, refQueue);<br><br>        <span class="hljs-comment">// lazily install the 2nd level valuesMap for the particular cacheKey</span><br>        ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap = map.get(cacheKey);<br>        <span class="hljs-keyword">if</span> (valuesMap == <span class="hljs-keyword">null</span>) &#123;<br>            ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; oldValuesMap<br>                = map.putIfAbsent(cacheKey,<br>                                  valuesMap = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;());<br>            <span class="hljs-keyword">if</span> (oldValuesMap != <span class="hljs-keyword">null</span>) &#123;<br>                valuesMap = oldValuesMap;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// create subKey and retrieve the possible Supplier&lt;V&gt; stored by that</span><br>        <span class="hljs-comment">// subKey from valuesMap</span><br>        Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter));<br>        Supplier&lt;V&gt; supplier = valuesMap.get(subKey);<br>        Factory factory = <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>            <span class="hljs-keyword">if</span> (supplier != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-comment">// supplier might be a Factory or a CacheValue&lt;V&gt; instance</span><br>                V value = supplier.get();<br>                <span class="hljs-keyword">if</span> (value != <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-keyword">return</span> value;<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// else no supplier in cache</span><br>            <span class="hljs-comment">// or a supplier that returned null (could be a cleared CacheValue</span><br>            <span class="hljs-comment">// or a Factory that wasn&#x27;t successful in installing the CacheValue)</span><br><br>            <span class="hljs-comment">// lazily construct a Factory</span><br>            <span class="hljs-keyword">if</span> (factory == <span class="hljs-keyword">null</span>) &#123;<br>                factory = <span class="hljs-keyword">new</span> Factory(key, parameter, subKey, valuesMap);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (supplier == <span class="hljs-keyword">null</span>) &#123;<br>                supplier = valuesMap.putIfAbsent(subKey, factory);<br>                <span class="hljs-keyword">if</span> (supplier == <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-comment">// successfully installed Factory</span><br>                    supplier = factory;<br>                &#125;<br>                <span class="hljs-comment">// else retry with winning supplier</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (valuesMap.replace(subKey, supplier, factory)) &#123;<br>                    <span class="hljs-comment">// successfully replaced</span><br>                    <span class="hljs-comment">// cleared CacheEntry / unsuccessful Factory</span><br>                    <span class="hljs-comment">// with our Factory</span><br>                    supplier = factory;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// retry with current supplier</span><br>                    supplier = valuesMap.get(subKey);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>Supplier<V> supplier = valuesMap.get(subKey);</p>
<p>get方法返回值为： supplier.get()</p>
<p>进入WeakCache内部类Factory的get()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Factory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Supplier</span>&lt;<span class="hljs-title">V</span>&gt; </span>&#123;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> K key;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> P parameter;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object subKey;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap;<br><br>        Factory(K key, P parameter, Object subKey,<br>                ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap) &#123;<br>            <span class="hljs-keyword">this</span>.key = key;<br>            <span class="hljs-keyword">this</span>.parameter = parameter;<br>            <span class="hljs-keyword">this</span>.subKey = subKey;<br>            <span class="hljs-keyword">this</span>.valuesMap = valuesMap;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> V <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-comment">// serialize access</span><br>            <span class="hljs-comment">// re-check</span><br>            Supplier&lt;V&gt; supplier = valuesMap.get(subKey);<br>            <span class="hljs-keyword">if</span> (supplier != <span class="hljs-keyword">this</span>) &#123;<br>                <span class="hljs-comment">// something changed while we were waiting:</span><br>                <span class="hljs-comment">// might be that we were replaced by a CacheValue</span><br>                <span class="hljs-comment">// or were removed because of failure -&gt;</span><br>                <span class="hljs-comment">// return null to signal WeakCache.get() to retry</span><br>                <span class="hljs-comment">// the loop</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br>            <span class="hljs-comment">// else still us (supplier == this)</span><br><br>            <span class="hljs-comment">// create new value</span><br>            V value = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                value = Objects.requireNonNull(valueFactory.apply(key, parameter));<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) &#123; <span class="hljs-comment">// remove us on failure</span><br>                    valuesMap.remove(subKey, <span class="hljs-keyword">this</span>);<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// the only path to reach here is with non-null value</span><br>            <span class="hljs-keyword">assert</span> value != <span class="hljs-keyword">null</span>;<br><br>            <span class="hljs-comment">// wrap value with CacheValue (WeakReference)</span><br>            CacheValue&lt;V&gt; cacheValue = <span class="hljs-keyword">new</span> CacheValue&lt;&gt;(value);<br><br>            <span class="hljs-comment">// put into reverseMap</span><br>            reverseMap.put(cacheValue, Boolean.TRUE);<br><br>            <span class="hljs-comment">// try replacing us with CacheValue (this should always succeed)</span><br>            <span class="hljs-keyword">if</span> (!valuesMap.replace(subKey, <span class="hljs-keyword">this</span>, cacheValue)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AssertionError(<span class="hljs-string">&quot;Should not reach here&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-comment">// successfully replaced us with new CacheValue -&gt; return the value</span><br>            <span class="hljs-comment">// wrapped by it</span><br>            <span class="hljs-keyword">return</span> value;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>返回值value= Objects.requireNonNull(valueFactory.apply(key, parameter));</p>
<p>进入valueFactory.apply(key, parameter)方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProxyClassFactory</span></span><br><span class="hljs-class">    <span class="hljs-keyword">implements</span> <span class="hljs-title">BiFunction</span>&lt;<span class="hljs-title">ClassLoader</span>, <span class="hljs-title">Class</span>&lt;?&gt;[], <span class="hljs-title">Class</span>&lt;?&gt;&gt;</span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-comment">// prefix for all proxy class names</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String proxyClassNamePrefix = <span class="hljs-string">&quot;$Proxy&quot;</span>;<br><br>    <span class="hljs-comment">// next number to use for generation of unique proxy class names</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AtomicLong nextUniqueNumber = <span class="hljs-keyword">new</span> AtomicLong();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123;<br><br>        Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = <span class="hljs-keyword">new</span> IdentityHashMap&lt;&gt;(interfaces.length);<br>        <span class="hljs-keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * Verify that the class loader resolves the name of this</span><br><span class="hljs-comment">             * interface to the same Class object.</span><br><span class="hljs-comment">             */</span><br>            Class&lt;?&gt; interfaceClass = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                interfaceClass = Class.forName(intf.getName(), <span class="hljs-keyword">false</span>, loader);<br>            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (interfaceClass != intf) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<br>                    intf + <span class="hljs-string">&quot; is not visible from class loader&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * Verify that the Class object actually represents an</span><br><span class="hljs-comment">             * interface.</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">if</span> (!interfaceClass.isInterface()) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<br>                    interfaceClass.getName() + <span class="hljs-string">&quot; is not an interface&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * Verify that this interface is not a duplicate.</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">if</span> (interfaceSet.put(interfaceClass, Boolean.TRUE) != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<br>                    <span class="hljs-string">&quot;repeated interface: &quot;</span> + interfaceClass.getName());<br>            &#125;<br>        &#125;<br><br>        String proxyPkg = <span class="hljs-keyword">null</span>;     <span class="hljs-comment">// package to define proxy class in</span><br>        <span class="hljs-keyword">int</span> accessFlags = Modifier.PUBLIC | Modifier.FINAL;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * Record the package of a non-public proxy interface so that the</span><br><span class="hljs-comment">         * proxy class will be defined in the same package.  Verify that</span><br><span class="hljs-comment">         * all non-public proxy interfaces are in the same package.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;<br>            <span class="hljs-keyword">int</span> flags = intf.getModifiers();<br>            <span class="hljs-keyword">if</span> (!Modifier.isPublic(flags)) &#123;<br>                accessFlags = Modifier.FINAL;<br>                String name = intf.getName();<br>                <span class="hljs-keyword">int</span> n = name.lastIndexOf(<span class="hljs-string">&#x27;.&#x27;</span>);<br>                String pkg = ((n == -<span class="hljs-number">1</span>) ? <span class="hljs-string">&quot;&quot;</span> : name.substring(<span class="hljs-number">0</span>, n + <span class="hljs-number">1</span>));<br>                <span class="hljs-keyword">if</span> (proxyPkg == <span class="hljs-keyword">null</span>) &#123;<br>                    proxyPkg = pkg;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!pkg.equals(proxyPkg)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<br>                        <span class="hljs-string">&quot;non-public interfaces from different packages&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (proxyPkg == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-comment">// if no non-public proxy interfaces, use com.sun.proxy package</span><br>            proxyPkg = ReflectUtil.PROXY_PACKAGE + <span class="hljs-string">&quot;.&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * Choose a name for the proxy class to generate.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">long</span> num = nextUniqueNumber.getAndIncrement();<br>        String proxyName = proxyPkg + proxyClassNamePrefix + num;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * Generate the specified proxy class.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">byte</span>[] proxyClassFile = ProxyGenerator.generateProxyClass(<br>            proxyName, interfaces, accessFlags);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> defineClass0(loader, proxyName,<br>                                proxyClassFile, <span class="hljs-number">0</span>, proxyClassFile.length);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassFormatError e) &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * A ClassFormatError here means that (barring bugs in the</span><br><span class="hljs-comment">             * proxy class generation code) there was some other</span><br><span class="hljs-comment">             * invalid aspect of the arguments supplied to the proxy</span><br><span class="hljs-comment">             * class creation (such as virtual machine limitations</span><br><span class="hljs-comment">             * exceeded).</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(e.toString());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>发现重点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">byte</span>[] proxyClassFile = ProxyGenerator.generateProxyClass(<br>    proxyName, interfaces, accessFlags);<br></code></pre></td></tr></table></figure>

<p>这里生成了代理类的字节码文件</p>
<p>通过反编译可以很清楚的看到代理类暂且叫做MyProxy继承了Proxy类并且实现了参数里的所有接口，另外MyProxy有一个构造方法：</p>
<p>public MyProxy(InvocationHandler paramInvocationHandler){</p>
<p>​    super(paramInvocationHandler);</p>
<p>}</p>
<p>MyProxy的父类Proxy类中的构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">Proxy</span><span class="hljs-params">(InvocationHandler h)</span> </span>&#123;<br>    Objects.requireNonNull(h);<br>    <span class="hljs-keyword">this</span>.h = h;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>MyProxy类结构大概如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.lang.reflect.UndeclaredThrowableException;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyProxy</span></span><br><span class="hljs-class">  <span class="hljs-keyword">extends</span> <span class="hljs-title">Proxy</span></span><br><span class="hljs-class">  <span class="hljs-keyword">implements</span> 接口</span><br><span class="hljs-class"></span>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m1;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m3;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m4;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m2;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m0;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyProxy</span><span class="hljs-params">(InvocationHandler paramInvocationHandler)</span></span><br><span class="hljs-function">  </span>&#123;<br>     <span class="hljs-keyword">super</span>(paramInvocationHandler);<br>  &#125;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object paramObject)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      <span class="hljs-keyword">return</span> ((Boolean)<span class="hljs-keyword">this</span>.h.invoke(<span class="hljs-keyword">this</span>, m1, <span class="hljs-keyword">new</span> Object[] &#123; paramObject &#125;)).booleanValue();<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Error|RuntimeException localError)<br>    &#123;<br>      <span class="hljs-keyword">throw</span> localError;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable localThrowable)<br>    &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndeclaredThrowableException(localThrowable);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title">SayGoodBye</span><span class="hljs-params">()</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      <span class="hljs-keyword">return</span> (String)<span class="hljs-keyword">this</span>.h.invoke(<span class="hljs-keyword">this</span>, m3, <span class="hljs-keyword">null</span>);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Error|RuntimeException localError)<br>    &#123;<br>      <span class="hljs-keyword">throw</span> localError;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable localThrowable)<br>    &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndeclaredThrowableException(localThrowable);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title">SayHello</span><span class="hljs-params">(String paramString)</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      <span class="hljs-keyword">return</span> (String)<span class="hljs-keyword">this</span>.h.invoke(<span class="hljs-keyword">this</span>, m4, <span class="hljs-keyword">new</span> Object[] &#123; paramString &#125;);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Error|RuntimeException localError)<br>    &#123;<br>      <span class="hljs-keyword">throw</span> localError;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable localThrowable)<br>    &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndeclaredThrowableException(localThrowable);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      <span class="hljs-keyword">return</span> (String)<span class="hljs-keyword">this</span>.h.invoke(<span class="hljs-keyword">this</span>, m2, <span class="hljs-keyword">null</span>);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Error|RuntimeException localError)<br>    &#123;<br>      <span class="hljs-keyword">throw</span> localError;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable localThrowable)<br>    &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndeclaredThrowableException(localThrowable);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      <span class="hljs-keyword">return</span> ((Integer)<span class="hljs-keyword">this</span>.h.invoke(<span class="hljs-keyword">this</span>, m0, <span class="hljs-keyword">null</span>)).intValue();<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Error|RuntimeException localError)<br>    &#123;<br>      <span class="hljs-keyword">throw</span> localError;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable localThrowable)<br>    &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndeclaredThrowableException(localThrowable);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-keyword">static</span><br>  &#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      m1 = Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="hljs-string">&quot;equals&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123; Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>) &#125;);<br>      m3 = Class.forName(<span class="hljs-string">&quot;jiankunking.Subject&quot;</span>).getMethod(<span class="hljs-string">&quot;SayGoodBye&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]);<br>      m4 = Class.forName(<span class="hljs-string">&quot;jiankunking.Subject&quot;</span>).getMethod(<span class="hljs-string">&quot;SayHello&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123; Class.forName(<span class="hljs-string">&quot;java.lang.String&quot;</span>) &#125;);<br>      m2 = Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]);<br>      m0 = Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="hljs-string">&quot;hashCode&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (NoSuchMethodException localNoSuchMethodException)<br>    &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NoSuchMethodError(localNoSuchMethodException.getMessage());<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (ClassNotFoundException localClassNotFoundException)<br>    &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NoClassDefFoundError(localClassNotFoundException.getMessage());<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="2-CGLib动态代理："><a href="#2-CGLib动态代理：" class="headerlink" title="2.CGLib动态代理："></a>2.CGLib动态代理：</h3><p>CGLIB是一个基于ASM框架的字节码生成库，它允许我们在运行时对字节码进行修改和动态生成。CGLIB通过继承的方式实现代理，在子类中采用拦截的技术拦截所有父类的调用并顺势织入横切逻辑。</p>
<p>CGLib例子：</p>
<p>写一个目标类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Target</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;juest do it&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>写一个类并且实现接口 net.sf.cglib.proxy.MethodInterceptor</p>
<p>首先看看接口net.sf.cglib.proxy.MethodInterceptor的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MethodInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Callback</span> </span>&#123;<br>    <span class="hljs-function">Object <span class="hljs-title">intercept</span><span class="hljs-params">(Object var1, Method var2, Object[] var3, MethodProxy var4)</span> <span class="hljs-keyword">throws</span> Throwable</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>再看看他的父类Callback的源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Callback</span> </span>&#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>所以我们现在自定义一个类MyMethodInterceptor并实现MethodInterceptor接口的intercept方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyMethodInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MethodInterceptor</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">intercept</span><span class="hljs-params">(Object obj, Method method, Object[] args, MethodProxy methodProxy)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;before just do it&quot;</span>);<br>        Object object = methodProxy.invokeSuper(obj,args);<span class="hljs-comment">//just do it</span><br>        SYstem.out.println(<span class="hljs-string">&quot;after just do it&quot;</span>);<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>客户类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;<br>        Enhancer enhancer = <span class="hljs-keyword">new</span> Enhancer();<br>        enhancer.setSuperclass(Target.class);<br>        enhancer.setCallback(<span class="hljs-keyword">new</span> MyMethodInterceptor());<br>        Target targetProxy = (Target)enhancer.create();<br>        target.dosomething();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>根据使用CGLib创建动态代理对象过程分析源码：</p>
<p>可以看到先是实例化了一个Enhancer(所在的包net.sf.cglib.proxy.Enhancer)对象 enhancer</p>
<p>接着调用的两个set方法：</p>
<p>setSuperclass(目标类的Class对象)和setCallback(实现了MethodInterceptor接口的对象)</p>
<p>它们的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Class superclass;	   <br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSuperclass</span><span class="hljs-params">(Class superclass)</span> </span>&#123;<br>       <span class="hljs-keyword">if</span> (superclass != <span class="hljs-keyword">null</span> &amp;&amp; superclass.isInterface()) &#123;<br>           <span class="hljs-keyword">this</span>.setInterfaces(<span class="hljs-keyword">new</span> Class[]&#123;superclass&#125;);<br>       &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (superclass != <span class="hljs-keyword">null</span> &amp;&amp; superclass.equals(Object.class)) &#123;<br>           <span class="hljs-keyword">this</span>.superclass = <span class="hljs-keyword">null</span>;<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-keyword">this</span>.superclass = superclass;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Callback[] callbacks;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCallback</span><span class="hljs-params">(Callback callback)</span> </span>&#123;<br>       <span class="hljs-keyword">this</span>.setCallbacks(<span class="hljs-keyword">new</span> Callback[]&#123;callback&#125;);<br>  	 &#125;<br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCallbacks</span><span class="hljs-params">(Callback[] callbacks)</span> </span>&#123;<br>       <span class="hljs-keyword">if</span> (callbacks != <span class="hljs-keyword">null</span> &amp;&amp; callbacks.length == <span class="hljs-number">0</span>) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Array cannot be empty&quot;</span>);<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-keyword">this</span>.callbacks = callbacks;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>重点地方是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Target targetProxy = (Target)enhancer.create();<br></code></pre></td></tr></table></figure>

<p>进入creat()源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.classOnly = <span class="hljs-keyword">false</span>;<br>    <span class="hljs-keyword">this</span>.argumentTypes = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.createHelper();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>没有重点再进入createHelper()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">createHelper</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.preValidate();<br>    Object key = KEY_FACTORY.newInstance(<span class="hljs-keyword">this</span>.superclass != <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">this</span>.superclass.getName() : <span class="hljs-keyword">null</span>, ReflectUtils.getNames(<span class="hljs-keyword">this</span>.interfaces), <span class="hljs-keyword">this</span>.filter == ALL_ZERO ? <span class="hljs-keyword">null</span> : <span class="hljs-keyword">new</span> WeakCacheKey(<span class="hljs-keyword">this</span>.filter), <span class="hljs-keyword">this</span>.callbackTypes, <span class="hljs-keyword">this</span>.useFactory, <span class="hljs-keyword">this</span>.interceptDuringConstruction, <span class="hljs-keyword">this</span>.serialVersionUID);<br>    <span class="hljs-keyword">this</span>.currentKey = key;<br>    Object result = <span class="hljs-keyword">super</span>.create(key);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看到返回值result=super.create(key)；</p>
<p>进入再看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">create</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ClassLoader loader = <span class="hljs-keyword">this</span>.getClassLoader();<br>            Map&lt;ClassLoader, AbstractClassGenerator.ClassLoaderData&gt; cache = CACHE;<br>            AbstractClassGenerator.ClassLoaderData data = (AbstractClassGenerator.ClassLoaderData)cache.get(loader);<br>            <span class="hljs-keyword">if</span> (data == <span class="hljs-keyword">null</span>) &#123;<br>                Class var5 = AbstractClassGenerator.class;<br>                <span class="hljs-keyword">synchronized</span>(AbstractClassGenerator.class) &#123;<br>                    cache = CACHE;<br>                    data = (AbstractClassGenerator.ClassLoaderData)cache.get(loader);<br>                    <span class="hljs-keyword">if</span> (data == <span class="hljs-keyword">null</span>) &#123;<br>                        Map&lt;ClassLoader, AbstractClassGenerator.ClassLoaderData&gt; newCache = <span class="hljs-keyword">new</span> WeakHashMap(cache);<br>                        data = <span class="hljs-keyword">new</span> AbstractClassGenerator.ClassLoaderData(loader);<br>                        newCache.put(loader, data);<br>                        CACHE = newCache;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">this</span>.key = key;<br>            Object obj = data.get(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.getUseCache());<br>            <span class="hljs-keyword">return</span> obj <span class="hljs-keyword">instanceof</span> Class ? <span class="hljs-keyword">this</span>.firstInstance((Class)obj) : <span class="hljs-keyword">this</span>.nextInstance(obj);<br>        &#125; <span class="hljs-keyword">catch</span> (RuntimeException var9) &#123;<br>            <span class="hljs-keyword">throw</span> var9;<br>        &#125; <span class="hljs-keyword">catch</span> (Error var10) &#123;<br>            <span class="hljs-keyword">throw</span> var10;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CodeGenerationException(var11);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>追踪</p>
<p>Object obj = data.get(this, this.getUseCache());</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(AbstractClassGenerator gen, <span class="hljs-keyword">boolean</span> useCache)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!useCache) &#123;<br>        <span class="hljs-keyword">return</span> gen.generate(<span class="hljs-keyword">this</span>);<span class="hljs-comment">//追踪进去</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        Object cachedValue = <span class="hljs-keyword">this</span>.generatedClasses.get(gen);<br>        <span class="hljs-keyword">return</span> gen.unwrapCachedValue(cachedValue);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Class <span class="hljs-title">generate</span><span class="hljs-params">(AbstractClassGenerator.ClassLoaderData data)</span> </span>&#123;<br>        Object save = CURRENT.get();<br>        CURRENT.set(<span class="hljs-keyword">this</span>);<br><br>        Class var8;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ClassLoader classLoader = data.getClassLoader();<br>            <span class="hljs-keyword">if</span> (classLoader == <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;ClassLoader is null while trying to define class &quot;</span> + <span class="hljs-keyword">this</span>.getClassName() + <span class="hljs-string">&quot;. It seems that the loader has been expired from a weak reference somehow. Please file an issue at cglib&#x27;s issue tracker.&quot;</span>);<br>            &#125;<br><br>            String className;<br>            <span class="hljs-keyword">synchronized</span>(classLoader) &#123;<br>                className = <span class="hljs-keyword">this</span>.generateClassName(data.getUniqueNamePredicate());<br>                data.reserveName(className);<br>                <span class="hljs-keyword">this</span>.setClassName(className);<br>            &#125;<br><br>            Class gen;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.attemptLoad) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    gen = classLoader.loadClass(<span class="hljs-keyword">this</span>.getClassName());<br>                    Class var25 = gen;<br>                    <span class="hljs-keyword">return</span> var25;<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var20) &#123;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">byte</span>[] b = <span class="hljs-keyword">this</span>.strategy.generate(<span class="hljs-keyword">this</span>);<span class="hljs-comment">//新大陆，字节码文件</span><br>            className = ClassNameReader.getClassName(<span class="hljs-keyword">new</span> ClassReader(b));<br>            ProtectionDomain protectionDomain = <span class="hljs-keyword">this</span>.getProtectionDomain();<br>            <span class="hljs-comment">//根据字节码生成代理类对象</span><br>            <span class="hljs-keyword">synchronized</span>(classLoader) &#123;<br>                <span class="hljs-keyword">if</span> (protectionDomain == <span class="hljs-keyword">null</span>) &#123;<br>                    gen = ReflectUtils.defineClass(className, b, classLoader);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    gen = ReflectUtils.defineClass(className, b, classLoader, protectionDomain);<br>                &#125;<br>            &#125;<br><br>            var8 = gen;<br>        &#125; <span class="hljs-keyword">catch</span> (RuntimeException var21) &#123;<br>            <span class="hljs-keyword">throw</span> var21;<br>        &#125; <span class="hljs-keyword">catch</span> (Error var22) &#123;<br>            <span class="hljs-keyword">throw</span> var22;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var23) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CodeGenerationException(var23);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            CURRENT.set(save);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> var8;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>可以看到返回值是return obj instanceof Class ? this.firstInstance((Class)obj) : this.nextInstance(obj);</p>
<p>进入到Enhancer类中的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">nextInstance</span><span class="hljs-params">(Object instance)</span> </span>&#123;<br>    Enhancer.EnhancerFactoryData data = (Enhancer.EnhancerFactoryData)instance;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.classOnly) &#123;<br>        <span class="hljs-keyword">return</span> data.generatedClass;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        Class[] argumentTypes = <span class="hljs-keyword">this</span>.argumentTypes;<br>        Object[] arguments = <span class="hljs-keyword">this</span>.arguments;<br>        <span class="hljs-keyword">if</span> (argumentTypes == <span class="hljs-keyword">null</span>) &#123;<br>            argumentTypes = Constants.EMPTY_CLASS_ARRAY;<br>            arguments = <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> data.newInstance(argumentTypes, arguments, <span class="hljs-keyword">this</span>.callbacks);<span class="hljs-comment">//反射创建对象</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过字节码反编译出来大概如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Target</span>$$<span class="hljs-title">EnhancerByCGLIB</span>$$<span class="hljs-title">c7ae5d4e</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Target</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Factory</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Method CGLIB$doSomething$<span class="hljs-number">0</span>$Method;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> MethodProxy CGLIB$doSomething$<span class="hljs-number">0</span>$Proxy;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> CGLIB$STATICHOOK1() &#123;<br>        Class var0 = Class.forName(<span class="hljs-string">&quot;com.codezhao.designpattern.proxypattern.cglibproxy.Person$$EnhancerByCGLIB$$c7ae5d4e&quot;</span>);<br>        Class var1;<br>        CGLIB$run$<span class="hljs-number">0</span>$Method = ReflectUtils.findMethods(<span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;run&quot;</span>, <span class="hljs-string">&quot;()V&quot;</span>&#125;, (var1 = Class.forName(<span class="hljs-string">&quot;com.codezhao.designpattern.proxypattern.cglibproxy.Target&quot;</span>)).getDeclaredMethods())[<span class="hljs-number">0</span>];<br>        CGLIB$run$<span class="hljs-number">0</span>$Proxy = MethodProxy.create(var1, var0, <span class="hljs-string">&quot;()V&quot;</span>, <span class="hljs-string">&quot;doSomething&quot;</span>, <span class="hljs-string">&quot;CGLIB$doSomething$0&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> CGLIB$doSomething$<span class="hljs-number">0</span>() &#123;<br>        <span class="hljs-keyword">super</span>.doSomething();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span> </span>&#123;<br>        MethodInterceptor var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;<br>        <span class="hljs-keyword">if</span> (var10000 == <span class="hljs-keyword">null</span>) &#123;<br>            CGLIB$BIND_CALLBACKS(<span class="hljs-keyword">this</span>);<br>            var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (var10000 != <span class="hljs-keyword">null</span>) &#123;<br>            var10000.intercept(<span class="hljs-keyword">this</span>, CGLIB$doSomething$<span class="hljs-number">0</span>$Method, CGLIB$emptyArgs, CGLIB$doSomething$<span class="hljs-number">0</span>$Proxy);<span class="hljs-comment">//执行自定义拦截器</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">super</span>.doSomething();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代理类<code>doSomething()</code>方法中，会调用方法拦截器的<code>intercept()</code>方法，方法拦截器会通过某些手段找到代理类的<code>CGLIB$doSomething$0()</code>方法，最后实现调用父类即被代理类Target的doSomething()方法，这个手段在Jdk中是反射，而在Cglib中是一种新的机制-FastClass机制。</p>
<h3 id="总结：两种动态代理方式的特点"><a href="#总结：两种动态代理方式的特点" class="headerlink" title="总结：两种动态代理方式的特点"></a>总结：两种动态代理方式的特点</h3><p>JDK动态代理：</p>
<p>1.通过实现InvocationHandler接口创建自己的调用处理器</p>
<p>2.通过为Porxy类指定ClassLoader对象和一组interface来创建动态代理</p>
<p>3.通过反射机制获取动态代理类的构造函数，其唯一参数类型就是调用处理器接口类型</p>
<p>3.通过构造函数创建动态代理类实例，构造是调用处理器对象作为参数传入</p>
<p>JDK动态代理是面向接口的代理模式，如果被代理目标没有接口那么就无法使用。</p>
<p>CGLib动态代理：</p>
<p>利用ASM开源包，对目标对象类的class文件加载进来，通过修改其字节码生成子类来处理。CGLib动态代理是通过字节码底层继承目标类来实现的，因此如果目标类被final关键字所修饰，会代理失败。</p>
<p>CGLib创建的动态代理对象性能比JDK创建的动态代理对象的性能高不少，但是CGLib在创建代理对象时所花费的时间却比JDK多得多，所以对与单例的对象，因为无需频繁地创建对象，用CGLib比较合适，反之，使用JDK方式要更为合适一些。同时，由于CGLib是采用动态创建子类地方法，对于final修饰的方法，无法进行代理。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/java/">java</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/12/15/Spring%20AOP/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Spring AOP</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
